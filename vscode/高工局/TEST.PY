import requests
import os
import time
from datetime import datetime
import urllib3


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

headers = {
    "User-Agent": "Mozilla/5.0"
}

def fetch_first_jpeg(url):
    with requests.get(url, headers=headers, stream=True, timeout=10, verify=False) as r:
        bytes_data = bytes()
        for chunk in r.iter_content(chunk_size=1024):
            bytes_data += chunk
            a = bytes_data.find(b'\xff\xd8')
            b = bytes_data.find(b'\xff\xd9')
            if a != -1 and b != -1:
                return bytes_data[a:b+2]
        return None

CAMERA_LIST = {
    "åŒ— åœ‹é“3è™Ÿ 220K+330 ä¸­èˆˆç³»çµ±äº¤æµé“åˆ°è‰å±¯äº¤æµé“": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=595",
    "å— åœ‹é“3è™Ÿ 215K+319 éœ§å³°ç³»çµ±äº¤æµé“åˆ°è‰å±¯äº¤æµé“": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=276",
    "å— åœ‹é“3è™Ÿ 218K+085": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=1103",
    "å— åœ‹é“3è™Ÿ 217K+091 è‰å±¯äº¤æµé“åˆ°ä¸­èˆˆç³»çµ±äº¤æµé“": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=277",
    "å— åœ‹é“3è™Ÿ 219K+080 è‰å±¯äº¤æµé“åˆ°ä¸­èˆˆç³»çµ±äº¤æµé“": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=368",
    "å— åœ‹é“3è™Ÿ 221K+536 è‰å±¯äº¤æµé“åˆ°ä¸­èˆˆç³»çµ±äº¤æµé“": "https://cctvc.freeway.gov.tw/abs2mjpg/bmjpg?camera=369",
    

}

INTERVAL = 300
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
SAVE_DIR = os.path.join(BASE_DIR, "é«˜å·¥å±€å½±åƒ")
os.makedirs(SAVE_DIR, exist_ok=True)


for name in CAMERA_LIST:
    os.makedirs(os.path.join(SAVE_DIR, name), exist_ok=True)
while True:
    print(f"\n æŠ“å–æ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    for name, url in CAMERA_LIST.items():
        try:
            img = fetch_first_jpeg(url)
            if img:
                filename = datetime.now().strftime(f"{name}_%Y%m%d_%H%M%S.jpg")
                filepath = os.path.join(SAVE_DIR,name, filename)
                with open(filepath, 'wb') as f:
                    f.write(img)
                print(f"âœ… å„²å­˜æˆåŠŸï¼š{filepath}")
            else:
                print(f"âŒ è®€å–å¤±æ•—ï¼š{name}")
        except Exception as e:
            print(f"ğŸš« æ“·å–å¤±æ•—ï¼š{name}ï¼ŒéŒ¯èª¤ï¼š{e}")
    print(f"â³ ç­‰å¾… {INTERVAL} ç§’...å¾Œå†æ¬¡æŠ“å–\n")
    time.sleep(INTERVAL)